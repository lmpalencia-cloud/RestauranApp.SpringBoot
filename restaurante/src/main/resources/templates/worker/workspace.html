<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head><meta charset="UTF-8"><title>Workspace</title>
<link rel="stylesheet" th:href="@{/css/style.css}"></head>
<body>
  <header class="topbar">
    <h1>Espacio de trabajo - Trabajador</h1>
    <nav><a th:href="@{/logout}">Salir</a></nav>
  </header>

  <section class="container two-col">
    <div class="card">
      <h3>Mesas</h3>
      <ul>
        <li th:each="t : ${tables}">
          <strong th:text="${t.name}">Mesa</strong>
          <span th:text="${t.occupied ? ' (Ocupada)' : ''}"></span>
        </li>
      </ul>
    </div>

    <div class="card">
      <h3>Crear orden</h3>
<form th:action="@{/worker/order/create}" method="post" id="orderForm">
    <label>Tabla</label>
    <select name="tableId" required>
        <option th:each="t: ${tables}" th:value="${t.id}" th:text="${t.name}"></option>
    </select>

    <div>
        <label>Productos</label>
        <div th:each="p,iterStat : ${products}" class="product-row">
            <input type="checkbox"
                   th:id="${'prod-'+p.id}"
                   th:name="productIds"
                   th:value="${p.id}"
                   class="prod-check"/>

            <label th:for="${'prod-'+p.id}" 
                   th:text="${p.name + ' - $' + p.price}"></label>

            <input type="number" 
                   name="quantities"
                   min="1" 
                   value="1"
                   class="qty-input"
                   disabled />
            
            <!-- precio oculto para JS -->
            <span class="price" th:text="${p.price}" style="display:none;"></span>
        </div>
    </div>

    <h3>Total: $<span id="liveTotal">0</span></h3>

    <button class="btn" type="submit">Crear factura</button>
</form>
    </div>
  </section>
<script>
document.querySelectorAll('.prod-check').forEach((chk, idx) => {
    chk.addEventListener('change', updateTotal);
});

document.querySelectorAll('.qty-input').forEach((qty) => {
    qty.addEventListener('input', updateTotal);
});

function updateTotal() {
    let total = 0;

    document.querySelectorAll('.product-row').forEach(row => {
        const check = row.querySelector('.prod-check');
        const qty = row.querySelector('.qty-input');
        const price = parseFloat(row.querySelector('.price').textContent);

        if (check.checked) {
            qty.disabled = false;
            total += price * qty.value;
        } else {
            qty.disabled = true;
        }
    });

    document.getElementById('liveTotal').textContent = total.toFixed(2);
}
</script>
</body>
</html>
