<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pedido - Mesa</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<header class="topbar">
    <h1>Tomar Pedido</h1>
    <nav><a th:href="@{/worker/workspace}">Volver</a> | <a th:href="@{/logout}">Salir</a></nav>
</header>

<section class="container pedido-container">

    <!-- ======================= -->
    <!-- LISTA PRODUCTOS -->
    <!-- ======================= -->
    <div class="productos-box">
        <h2>Productos</h2>
        <div class="productos-grid">
            <!-- Tarjetas de productos -->
            <div class="producto-card" th:each="p : ${products}">
                <h3 th:text="${p.name}">Nombre</h3>
                <p th:text="${p.description}">Descripción</p>
                <div class="price">
                    $<span th:text="${p.price}">0.00</span>
                </div>
                <div class="card-actions">
                    <button class="btn-add" th:attr="data-id=${p.id}, data-name=${p.name}, data-price=${p.price}">+</button>
                    <button class="btn-remove" th:attr="data-id=${p.id}">-</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ======================= -->
    <!-- RESUMEN PEDIDO -->
    <!-- ======================= -->
    <div class="pedido-box">
        <h2>Pedido - [[${mesa.name}]]</h2>
        <ul id="pedido-lista" class="pedido-lista">
            <!-- Aquí se agregan productos por JS -->
        </ul>
        <div class="pedido-total">
            Total: $<span id="total-general">0</span>
        </div>
        <form th:action="@{/worker/pedido/guardar}" method="post">
    <input type="hidden" name="mesaId" th:value="${mesa.id}">
    <input type="hidden" id="pedido-json" name="pedidoJson">
    <button class="btn-guardar">Guardar Pedido</button>
</form>
    </div>
</section>

<!-- ========================================= -->
<!-- ESTILOS CSS -->
<!-- ========================================= -->
<style>
.pedido-container {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 25px;
}
.productos-box, .pedido-box {
    background: white;
    padding: 20px;
    border-radius: 15px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.06);
}
.productos-grid {
    margin-top: 20px;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 15px;
}
.producto-card {
    padding: 15px;
    border-radius: 12px;
    background: #f5f7ff;
    border: 2px solid #d0d8ff;
    transition: .2s;
}
.producto-card:hover {
    transform: translateY(-3px);
    border-color: #94a5ff;
}
.card-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}
.btn-add, .btn-remove {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    font-size: 20px;
    cursor: pointer;
    border: none;
    transition: .2s;
}
.btn-add {
    background: #28a745;
    color: white;
}
.btn-add:hover { background: #1f7f35; }
.btn-remove {
    background: #dc3545;
    color: white;
}
.btn-remove:hover { background: #a92833; }
.pedido-lista {
    list-style: none;
    padding: 0;
}
.pedido-lista li {
    display: flex;
    justify-content: space-between;
    padding: 8px;
    background: #eef1ff;
    margin-bottom: 6px;
    border-radius: 8px;
}
.pedido-total {
    margin-top: 20px;
    font-size: 22px;
    font-weight: bold;
}
.btn-guardar {
    margin-top: 20px;
    width: 100%;
    padding: 12px;
    background: #007bff;
    border: none;
    border-radius: 10px;
    color: white;
    font-size: 16px;
    cursor: pointer;
}
.btn-guardar:hover {
    background: #0056b3;
}
</style>

<!-- ========================================= -->
<!-- LÓGICA JS DEL PEDIDO -->
<!-- ========================================= -->
<script>
let pedido = {};
const lista = document.getElementById("pedido-lista");
const totalGeneral = document.getElementById("total-general");
const inputPedido = document.getElementById("pedido-json");

document.querySelectorAll(".btn-add").forEach(btn => {
    btn.addEventListener("click", () => {
        let id = btn.dataset.id;
        let name = btn.dataset.name;
        let price = parseFloat(btn.dataset.price);

        if (!pedido[id]) pedido[id] = { nombre: name, precio: price, cantidad: 0 };
        pedido[id].cantidad++;
        actualizarVista();
    });
});

document.querySelectorAll(".btn-remove").forEach(btn => {
    btn.addEventListener("click", () => {
        let id = btn.dataset.id;
        if (pedido[id]) {
            pedido[id].cantidad--;
            if (pedido[id].cantidad <= 0) delete pedido[id];
            actualizarVista();
        }
    });
});

function actualizarVista() {
    lista.innerHTML = "";
    let total = 0;
    Object.keys(pedido).forEach(id => {
        let p = pedido[id];
        let subtotal = p.precio * p.cantidad;
        total += subtotal;
        lista.innerHTML += `<li><span>${p.nombre} (${p.cantidad})</span><span>$${subtotal.toFixed(2)}</span></li>`;
    });
    totalGeneral.textContent = total.toFixed(2);
    inputPedido.value = JSON.stringify(pedido);
}
const form = document.querySelector("form");

form.addEventListener("submit", function(e) {
    if (Object.keys(pedido).length === 0) {
        e.preventDefault();
        alert("No se puede guardar un pedido vacío. Por favor, selecciona al menos un producto.");
    }
});
</script>

</body>
</html>
